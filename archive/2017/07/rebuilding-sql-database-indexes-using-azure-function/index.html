
<!DOCTYPE html>
<html dir="ltr" lang="en-US">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width" />
     <link rel="shortcut icon" href="/images/favicon.ico">
    <meta http-equiv="last-modified" content="2019-07-16T18:23:39.2236387+01:00" />
    <meta name="keywords" content="Azure" />
	
    <link rel="alternate" type="application/rss+xml" title="RSS - Guilherme Ferreira Blog" href="/rss.xml" />
    <link rel="alternate" type="application/atom+xml" title="Atom - Guilherme Ferreira Blog" href="/feed.xml" />
	
    <title>
            Rebuilding SQL Database indexes using Azure Function - 
        Guilherme Ferreira
    </title>
    <meta name="description" content="Guilherme Ferreira blog - Developer, Entrepreneur, Foodie, Addicted to coffee">
    <link rel="stylesheet" type="text/css" href="/stylesheets/font-awesome/css/font-awesome.min.css" />
    <link rel="stylesheet" type="text/css" href="/stylesheets/style.css" />
    <link rel="canonical" href="http://gsferreira.com/archive/2017/07/rebuilding-sql-database-indexes-using-azure-function/" />
</head>
<body class="home blog">
    <div id="page" class="hfeed site">
        
	<header id="masthead" class="simple-header" role="banner">
	<hgroup>
		<a href="/" title="Home"><img width="40" height="40" src="/images/logo.jpg" title="logo"  alt="logo"></a>
		<h1 class="site-title"><a href="/" title="Snow Byte" rel="home">Guilherme Ferreira</a>
	</hgroup>
</header>
        

        <div id="main">
            <div id="primary" class="site-content">
                <div id="content" role="main">
                  


<div class="post">
    <h1>Rebuilding SQL Database indexes using Azure Function</h1> 
      <div class="meta">
        <p class="posted">20 Jul 2017</p>
        <ul class="categories">
          <li><a href="/category/azure" title="Snow.Models.Category">Azure</a></li>
        </ul>
      </div>
    </div>
    
    
        
    <p>Do you know that index management is under your responsibility and you need to pay attention to how fragmented they are? If you are reading this post, probably you know that (I hope that you didn't find it in the hard way).</p>

<p>Azure SQL Database takes care of a lot of maintenance tasks, but keeping your Indexes healthy isn't one of them. </p>

<p>Indexes get fragmented and fragmented indexes is a performance killer. The good news is that I can help you dealing with that.</p>

<!--excerpt-->

<h2>Do I have a problem?</h2>

<p>First let's analyze your database. Read <a href="https://blog.sqlauthority.com/2010/01/12/sql-server-fragmentation-detect-fragmentation-and-eliminate-fragmentation/">this article</a> to undestand the fragmentation indexs and then execute the following query in your database.</p>

<script src="https://gist.github.com/gsferreira/fbb3419a367730f53922f0809991d264.js"></script>

<p>Scared with the results? If so, keep reading. </p>

<h2>Azure Function</h2>

<p>You can find <a href="https://github.com/gsferreira/AzureFunctionSQLDefrag">here</a> the code of an Azure Function to automate the index maintenance of multiple databases.</p>

<p>The function will run and execute a REBUILD and REORGANIZE for Database Indexs, with a given Threshold.</p>

<p>By default, the Function is configured to Rebuild indexs with more than 30% of fragmentation and reorganize indexs with more than 3% but you can adjust those limits. </p>

<p>You can add a Connection String to multiple databases at the Application Settings where the name has the prefix "Defrag.".</p>

<p>You can find information of how to configure it in the project readme file.</p>

<h3>Important Note!!!</h3>

<p><em>The default timeout for functions on a Consumption plan is 5 minutes. The value can be increased to 10 minutes max.</em></p>

<p><em>If you have a big database, the function can stop running during the index maintenance and don't finish the job.</em></p>

<p><em>In that case, you probably want to move to an App Service plan or decompose the function splitting the work by multiple functions. If you want some tips of how to accomplish that, please leave a comment.</em></p>

<p><strong>References:</strong></p>

<ul>
<li><a href="https://blog.sqlauthority.com/2010/01/12/sql-server-fragmentation-detect-fragmentation-and-eliminate-fragmentation/">https://blog.sqlauthority.com/2010/01/12/sql-server-fragmentation-detect-fragmentation-and-eliminate-fragmentation/</a></li>
<li><a href="https://geeks.ms/davidjrh/2015/10/08/rebuilding-sql-database-indexes-using-azure-automation/">https://geeks.ms/davidjrh/2015/10/08/rebuilding-sql-database-indexes-using-azure-automation/</a></li>
<li><a href="https://alexandrebrisebois.wordpress.com/2013/02/06/dont-forget-about-index-maintenance-on-windows-azure-sql-database/">https://alexandrebrisebois.wordpress.com/2013/02/06/dont-forget-about-index-maintenance-on-windows-azure-sql-database/</a></li>
<li><a href="https://www.red-gate.com/simple-talk/cloud/cloud-data/azure-sql-database-maintenance/">https://www.red-gate.com/simple-talk/cloud/cloud-data/azure-sql-database-maintenance/</a></li>
</ul>



	<div class="post-social-links">
        <a href="http://twitter.com/gsferreira"><img src="/images/000-twitter-bird-48.png" title="gsferreira"/></a>
        <a href="http://gsferreira.com/rss.xml"><img src="/images/000-rss-feeds-48.png" title="gsferreira.com feed" onClick="_gaq.push(['_trackEvent', 'Post', 'RssSubscribe', 'Rss Subscribe on Post']);"/></a>
    </div>
	<div class="addthis_toolbox addthis_default_style" style="float:right;">
        <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
        <a class="addthis_button_tweet"></a>
        <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
        <a class="addthis_button_linkedin_counter"></a>
        <a class="addthis_counter addthis_pill_style"></a>
    </div>
	
    <div id="disqus_thread"></div>
<script>
    var reset_disqus = function(){
        DISQUS.reset({
            reload: true,
            config: function () {
                //this.page.identifier = '';
                this.page.url = 'http://gsferreira.com/archive/2017/07/rebuilding-sql-database-indexes-using-azure-function/';
                //this.page.title = '';
            }
        });
    };

    var disqus_shortname = 'gsferreira';
    var disqus_url = 'http://gsferreira.com/archive/2017/07/rebuilding-sql-database-indexes-using-azure-function/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    window.addEventListener('orientationchange', reset_disqus);
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-****"></script>


                </div>
                <!-- #content -->
            </div>
            <!-- #primary .site-content -->
        </div>
        <!-- #main -->

        <footer class="site-footer" role="contentinfo">
            <div class="site-info">
                Powered by <a href="https://github.com/Sandra/Sandra.Snow" rel="generator">Sandra.Snow</a> using <a href="https://github.com/gsferreira/letsnow" rel="generator">letsnow theme</a>.	
            </div>
            <!-- .site-info -->
        </footer>
        <!-- #colophon .site-footer -->
    </div>
    <!-- #page .hfeed .site -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script src='/javascripts/prettify.js' type='text/javascript'></script>
    
    <script type="text/javascript">
var _gaq = _gaq || [];

_gaq.push(['_setAccount', 'UA-33436813-1']);
_gaq.push(['_trackPageview']);
        
(function () {
    var ga = document.createElement('script');
    ga.type = 'text/javascript';
    ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(ga, s);
})();
</script>
    
    <script type='text/javascript'>
      $(function () {
        $("pre code").parent().each(function () {
          if (!$(this).hasClass("prettyprint")) {
            $(this).addClass("prettyprint");
            a = true
          }
        });

        prettyPrint();
      });
    </script>
</body>
</html>
