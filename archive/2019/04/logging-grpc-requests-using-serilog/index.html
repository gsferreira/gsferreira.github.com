
<!DOCTYPE html>
<html dir="ltr" lang="en-US">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width" />
    <link rel="shortcut icon" href="/images/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
    <link rel="manifest" href="/images/site.webmanifest">

    <meta http-equiv="last-modified" content="2020-07-08T21:36:01.5640748+01:00" />
    <meta name="keywords" content=".net,.net Core,gRPC,Serilog" />
	
    <link rel="alternate" type="application/rss+xml" title="RSS - Guilherme Ferreira Blog" href="/rss.xml" />
    <link rel="alternate" type="application/atom+xml" title="Atom - Guilherme Ferreira Blog" href="/feed.xml" />
	
    <title>
            Logging gRPC requests using Serilog - 
        Guilherme Ferreira
    </title>
    <meta name="description" content="Guilherme Ferreira blog - Developer, Entrepreneur, Foodie, Addicted to coffee">
    <link rel="stylesheet" type="text/css" href="/stylesheets/font-awesome/css/font-awesome.min.css" />
    <link rel="stylesheet" type="text/css" href="/stylesheets/style.css?1" />
    <link rel="canonical" href="http://gsferreira.com/archive/2019/04/logging-grpc-requests-using-serilog/" />
</head>
<body class="home blog">
    <div id="page" class="hfeed site">
        
	<header id="masthead" class="simple-header" role="banner">
	<hgroup>
		<a href="/" title="Home"><img width="40" height="40" src="/images/logo.jpg" title="logo"  alt="logo"></a>
		<h1 class="site-title"><a href="/" title="Snow Byte" rel="home">Guilherme Ferreira</a>
	</hgroup>
</header>
        

        <div id="main">
            <div id="primary" class="site-content">
                <div id="content" role="main">
                  


<div class="post">
    <h1>Logging gRPC requests using Serilog</h1> 
      <div class="meta">
        <p class="posted">10 Apr 2019</p>
        <ul class="categories">
          <li><a href="/category/.net" title="Snow.Models.Category">.net</a></li>
          <li><a href="/category/.net-core" title="Snow.Models.Category">.net Core</a></li>
          <li><a href="/category/grpc" title="Snow.Models.Category">gRPC</a></li>
          <li><a href="/category/serilog" title="Snow.Models.Category">Serilog</a></li>
        </ul>
      </div>
    </div>
    
    
        
    <p>Using a Middleware to log Api Requests in ASP.NET Core is a no brainer.</p>

<p>If you have given a try to <a href="https://grpc.io/">gRPC</a>, probably you want to follow the same technique and you will wish that the experience was the same.</p>

<p>I've faced this challenge, in order to log the requests to my RPC services and I've been looking for a solution where:</p>

<ul>
<li>I can use <a href="https://serilog.net/">Serilog</a> to log the requests</li>
<li>I know all the requests made to my services</li>
<li>I know how long each request takes to respond</li>
<li>I know the response status</li>
<li>I can correlate each log entry using a Correlation ID</li>
</ul>

<!--excerpt-->

<p>To accomplish that in gRPC, I took advantage of an <strong>Interceptor</strong>.</p>

<p>Using an interceptor, you can intercept the invocation of GRPC methods and intercept Unary calls (Request/Response) or Streaming communication. </p>

<p>In this example, we will be using a <strong>Unary Interceptor</strong>.</p>

<p><em>This example has been done on top of gRPC HelloWorld sample in version 1.19.0</em></p>

<h2>Step 1: Install Serilog</h2>

<p>Start by download the Sample code from gRPC. You can find the instructions <a href="https://grpc.io/docs/quickstart/csharp.html">here</a>.</p>

<p>Install in the GreeterServer the serilog package <code>Install-Package Serilog.Sinks.Console -Version 3.1.1</code>.</p>

<p>I'm using the Console Sink for demonstration proposes. You can easily find tons of sinks like File, Seq, Application Insights, Datadog, etc.</p>

<p>To enable Serilog, create the logger at the beginning of the GreeterServer <em>Main</em>.</p>

<pre><code>public static void Main(string[] args)
    {
      Log.Logger = new LoggerConfiguration()
        .WriteTo.Console()
        .CreateLogger();
      (...)
    }
</code></pre>

<h2>Step 2: Create the Interceptor</h2>

<p>In the GreeterServer project create the <em>RequestLoggerInterceptor</em>.</p>

<pre><code>using Grpc.Core;
using Grpc.Core.Interceptors;
using Serilog;
using System.Diagnostics;
using System.Threading.Tasks;

namespace GreeterServer
{
  public class RequestLoggerInterceptor : Interceptor
  {
    private const string MessageTemplate =
      "{RequestMethod} responded {StatusCode} in {Elapsed:0.0000} ms";

    public override async Task&lt;TResponse&gt; UnaryServerHandler&lt;TRequest, TResponse&gt;(TRequest request, ServerCallContext context, UnaryServerMethod&lt;TRequest, TResponse&gt; continuation)
    {
      var sw = Stopwatch.StartNew();

      var response = await base.UnaryServerHandler(request, context, continuation);

      sw.Stop();
      Log.Logger.Information(MessageTemplate,
        context.Method,
        context.Status.StatusCode,
        sw.Elapsed.TotalMilliseconds);

      return response;
    }
  }
}
</code></pre>

<p>This interceptor is just logging the Status Code for each request and the time used to complete the execution.</p>

<h2>Step 3: Apply interceptor to the service</h2>

<p>To take effect, you need to bind the interceptor to the Service you want. To do that, go to the <em>Program.cs</em> and configure the Server service binding to use the interceptor for the Greeter service.</p>

<pre><code>using Grpc.Core.Interceptors;
(...)
Server server = new Server
{
  Services = { Greeter.BindService(new GreeterImpl()).Intercept(new RequestLoggerInterceptor()) },
    Ports = { new ServerPort("localhost", Port, ServerCredentials.Insecure) }
};
</code></pre>

<p>The Intercept method is an extension method, so don't forget to use <em>Grpc.Core.Interceptors</em> namespace.</p>

<p>If you run the samples now, you will see this as a result.</p>

<p><img src="/images/logging-grpc-requests-using-serilog-simple-log-line.png" alt="Log entry" /></p>

<h2>Step 4: Add Correlation ID</h2>

<p>If you have multiple services being part of the execution of a particular request, most probably you would take advantage of having a Correlation ID to track the execution of a given request in every service. If you don't have one, I highly recommend you to do it.</p>

<p>In this example, we will be sending the Correlation ID as an gRPC request header and change the Interceptor to add it to every log line.</p>

<p>Let's start by add the Correlation ID header to the RPC request done by <em>GreeterClient</em>.</p>

<pre><code>var reply = client.SayHello(new HelloRequest { Name = user }, new Metadata()
{
  new Metadata.Entry("X-Correlation-Id", Guid.NewGuid().ToString())
});
</code></pre>

<p><em>In this example, I'm generating a Guid just for demo purposes.</em></p>

<p>In the interceptor, access to the Correlation ID and push it to Serilog as a property. In this way, every single log entry on that context will have the Correlation Id property available.</p>

<pre><code>using Grpc.Core;
using Grpc.Core.Interceptors;
using Serilog;
using System;
using System.Diagnostics;
using System.Linq;
using System.Threading.Tasks;

namespace GreeterServer
{
  public class RequestLoggerInterceptor : Interceptor
  {
    private const string MessageTemplate =
      "{RequestMethod} responded {StatusCode} in {Elapsed:0.0000} ms";

    public override async Task&lt;TResponse&gt; UnaryServerHandler&lt;TRequest, TResponse&gt;(TRequest request,
      ServerCallContext context, UnaryServerMethod&lt;TRequest, TResponse&gt; continuation)
    {
      var sw = Stopwatch.StartNew();

      var correlationId = context.RequestHeaders
        .FirstOrDefault(h =&gt; h.Key.Equals("X-Correlation-Id", StringComparison.OrdinalIgnoreCase))?.Value;
      using (Serilog.Context.LogContext.PushProperty("CorrelationID", correlationId))
      {
        var response = await base.UnaryServerHandler(request, context, continuation);

        sw.Stop();
        Log.Logger.Information(MessageTemplate,
          context.Method,
          context.Status.StatusCode,
          sw.Elapsed.TotalMilliseconds);

        return response;
      }
    }
  }
}
</code></pre>

<p>To complete the work, we need to configure Serilog to use the Properties pushed to the context.</p>

<p>Go back to the <em>GreeterServer Program</em> and change the logger configuration to have a template where you use the Correlation ID and configure the log enrichment with the context properties.</p>

<pre><code>Log.Logger = new LoggerConfiguration()
        .Enrich.FromLogContext()
        .WriteTo.Console(outputTemplate: "{Timestamp:yyyy-MM-dd HH:mm:ss.fff zzz} [{Level}] [{CorrelationID}] {Message}{NewLine}{Exception}")
        .CreateLogger();
</code></pre>

<h2>Step 5: Profit!</h2>

<p>In this tutorial, we created a simple gRPC interceptor. Now you have a request log with status codes and timings.</p>

<p><img src="/images/logging-grpc-requests-using-serilog-simple-log-line-with-correlation-id.png" alt="Log entry with Correlation ID" /></p>

<p>Go ahead and give it a try.</p>


    

	<div class="post-social-links">
        <a href="https://twitter.com/gsferreira"><img src="/images/000-twitter-bird-48.png" title="gsferreira"/></a>
        <a href="https://gsferreira.com/rss.xml"><img src="/images/000-rss-feeds-48.png" title="gsferreira.com feed" onClick="_gaq.push(['_trackEvent', 'Post', 'RssSubscribe', 'Rss Subscribe on Post']);"/></a>
    </div>

  <br />
  
  <script async data-uid="6b1314a04e" src="https://gsferreira.ck.page/6b1314a04e/index.js"></script>


	<div class="addthis_toolbox addthis_default_style" style="float:right;">
        <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
        <a class="addthis_button_tweet"></a>
        <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
        <a class="addthis_button_linkedin_counter"></a>
        <a class="addthis_counter addthis_pill_style"></a>
    </div>
	
    <div id="disqus_thread"></div>
<script>
    var reset_disqus = function(){
        DISQUS.reset({
            reload: true,
            config: function () {
                //this.page.identifier = '';
                this.page.url = 'http://gsferreira.com/archive/2019/04/logging-grpc-requests-using-serilog/';
                //this.page.title = '';
            }
        });
    };

    var disqus_shortname = 'gsferreira';
    var disqus_url = 'http://gsferreira.com/archive/2019/04/logging-grpc-requests-using-serilog/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    window.addEventListener('orientationchange', reset_disqus);
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-****"></script>



                </div>
                <!-- #content -->
            </div>
            <!-- #primary .site-content -->
        </div>
        <!-- #main -->

        <footer class="site-footer" role="contentinfo">
            <div class="site-info">
                Powered by <a href="https://github.com/Sandra/Sandra.Snow" rel="generator">Sandra.Snow</a> using <a href="https://github.com/gsferreira/letsnow" rel="generator">letsnow theme</a>.	
            </div>
            <!-- .site-info -->
        </footer>
        <!-- #colophon .site-footer -->
    </div>
    <!-- #page .hfeed .site -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script src='/javascripts/prettify.js' type='text/javascript'></script>
    
    <script type="text/javascript">
var _gaq = _gaq || [];

_gaq.push(['_setAccount', 'UA-33436813-1']);
_gaq.push(['_trackPageview']);
        
(function () {
    var ga = document.createElement('script');
    ga.type = 'text/javascript';
    ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(ga, s);
})();
</script>
    
    <script type='text/javascript'>
      $(function () {
        $("pre code").parent().each(function () {
          if (!$(this).hasClass("prettyprint")) {
            $(this).addClass("prettyprint");
            a = true
          }
        });

        prettyPrint();
      });
    </script>
</body>
</html>
