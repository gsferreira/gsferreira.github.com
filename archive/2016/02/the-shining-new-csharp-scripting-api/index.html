
<!DOCTYPE html>
<html dir="ltr" lang="en-US">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width" />
    <link rel="shortcut icon" href="/images/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
    <link rel="manifest" href="/images/site.webmanifest">

    <meta http-equiv="last-modified" content="2020-06-02T22:41:15.0110863+01:00" />
    <meta name="keywords" content=".NET" />
	
    <link rel="alternate" type="application/rss+xml" title="RSS - Guilherme Ferreira Blog" href="/rss.xml" />
    <link rel="alternate" type="application/atom+xml" title="Atom - Guilherme Ferreira Blog" href="/feed.xml" />
	
    <title>
            The shining new C# Scripting API - 
        Guilherme Ferreira
    </title>
    <meta name="description" content="Guilherme Ferreira blog - Developer, Entrepreneur, Foodie, Addicted to coffee">
    <link rel="stylesheet" type="text/css" href="/stylesheets/font-awesome/css/font-awesome.min.css" />
    <link rel="stylesheet" type="text/css" href="/stylesheets/style.css?1" />
    <link rel="canonical" href="http://gsferreira.com/archive/2016/02/the-shining-new-csharp-scripting-api/" />
</head>
<body class="home blog">
    <div id="page" class="hfeed site">
        
	<header id="masthead" class="simple-header" role="banner">
	<hgroup>
		<a href="/" title="Home"><img width="40" height="40" src="/images/logo.jpg" title="logo"  alt="logo"></a>
		<h1 class="site-title"><a href="/" title="Snow Byte" rel="home">Guilherme Ferreira</a>
	</hgroup>
</header>
        

        <div id="main">
            <div id="primary" class="site-content">
                <div id="content" role="main">
                  


<div class="post">
    <h1>The shining new C# Scripting API</h1> 
      <div class="meta">
        <p class="posted">03 Feb 2016</p>
        <ul class="categories">
          <li><a href="/category/.net" title="Snow.Models.Category">.NET</a></li>
        </ul>
      </div>
    </div>
    
    
        
    <p><strong>Say hello to the new Scripting Language: C#!</strong></p>

<p>Since the first days the .NET platform lacks scripting capabilities compared to dynamic languages like JavaScript or Ruby, but those days are over.</p>

<p>Why this is awesome?! If you are familiar with the capabilities that VBA brings the Office users and how many "Excel VBA Programming" books were sold to non developers, you will understand why.
And it's <a href="https://github.com/dotnet/roslyn/tree/master/src/Scripting">open source</a>!!!</p>

<!--excerpt-->

<p>In the past few years we have been following the growing of the new .NET Compiler, commonly known as Roslyn. </p>

<p>One of the great features of Roslyn is the Scripting API. The scripting API can enable applications to evaluate code at runtime providing the API to implement an excellent scripting experience.</p>

<p>In December Microsoft finally released the Roslyn version 1.1.1 (stable version) in nuget that includes the Scripting API (that has been removed from Roslyn 1.0 release by the team). </p>

<p>Here you can find some examples of how to use the scripting API and what you can do with it.</p>

<h2>How to start</h2>

<p>Install the nuget Scripting package (<a href="http://www.nuget.org/packages/Microsoft.CodeAnalysis.CSharp.Scripting/">Microsoft.CodeAnalysis.CSharp.Scripting</a>) in your project.</p>

<p>In the following example I used the version 1.1.1.</p>

<pre><code>Install-Package Microsoft.CodeAnalysis.CSharp.Scripting -Version 1.1.1
</code></pre>

<h2>Expression evaluation</h2>

<p>Evaluate the result of an C# expression.</p>

<pre><code>object result = null;

CSharpScript.EvaluateAsync("System.DateTime.Today.Year")
    .ContinueWith(s =&gt; result = s.Result).Wait();

Assert.AreEqual(DateTime.Today.Year, result);
</code></pre>

<h2>Expression evaluation with strong type</h2>

<p>Evaluate an expression with an expected result type. </p>

<pre><code>int result = 0;

CSharpScript.EvaluateAsync&lt;int&gt;("100 * 2")
    .ContinueWith(s =&gt; result = s.Result).Wait();

Assert.AreEqual(200, result);
</code></pre>

<h2>Evaluation with parameters</h2>

<p>Send parameters to the expression and use them in the script logic. </p>

<pre><code>public class Globals
{
    public int NumberOfStudents;
    public int StudentsPerClass;
}

var globals = new Globals { NumberOfStudents = 80, StudentsPerClass = 15 };

int result = 0;
CSharpScript.EvaluateAsync&lt;int&gt;("NumberOfStudents/StudentsPerClass", globals: globals)
    .ContinueWith(s =&gt; result = s.Result).Wait();

Assert.AreEqual(globals.NumberOfStudents / globals.StudentsPerClass, result);
</code></pre>

<h2>Build a script and run it multiple times</h2>

<p>The scripting API enables you to create an expression and then use it multiple times, removing the compile time of the remaining evaluations.</p>

<pre><code>var script = CSharpScript.Create&lt;decimal&gt;("NumberOfStudents/StudentsPerClass", globalsType: typeof(Globals));

script.Compile();

for (int i = 1; i &lt; 10; i++)
{
    script.RunAsync(new Globals { NumberOfStudents = i, StudentsPerClass = 5 })
        .ContinueWith(s =&gt; 
            Assert.AreEqual(i / 5, s.Result.ReturnValue))
        .Wait();
};
</code></pre>

<h2>References</h2>

<p>The script can use references to other assemblies with a simple instruction.</p>

<pre><code>string result = string.Empty;

CSharpScript.EvaluateAsync&lt;string&gt;("System.Configuration.ConfigurationManager.AppSettings[\"MyValue\"].ToString()", 
ScriptOptions.Default.WithReferences(typeof(System.Configuration.ConfigurationManager).Assembly))
    .ContinueWith(s =&gt; result = s.Result).Wait();

Assert.AreEqual(ConfigurationManager.AppSettings["MyValue"].ToString(), result);
</code></pre>

<h2>Imports</h2>

<pre><code>int result = 0;
CSharpScript.EvaluateAsync&lt;int&gt;("DateTime.Today.Year",
ScriptOptions.Default.WithImports("System"))
    .ContinueWith(s =&gt; result = s.Result).Wait();

Assert.AreEqual(DateTime.Today.Year, result);
</code></pre>

<h2>Dynamic Support</h2>

<p>To use dynamic objects in scripts we need to add a reference to the <em>System.Code</em>, <em>Microsoft.CSharp</em> and <em>System.Dynamic</em>.</p>

<pre><code>int result = 0;

CSharpScript.EvaluateAsync&lt;int&gt;(@"
    dynamic value = 30;
    return value;",
ScriptOptions.Default.WithImports("System.Dynamic")
    .AddReferences(
        Assembly.GetAssembly(typeof(System.Dynamic.DynamicObject)),  // System.Code
        Assembly.GetAssembly(typeof(Microsoft.CSharp.RuntimeBinder.CSharpArgumentInfo)),  // Microsoft.CSharp
        Assembly.GetAssembly(typeof(System.Dynamic.ExpandoObject))  // System.Dynamic
    ))
    .ContinueWith(s =&gt; result = s.Result).Wait();

Assert.AreEqual(30, result);
</code></pre>

<h2>Access to script variables</h2>

<pre><code>var globals = new Globals { NumberOfStudents = 80, StudentsPerClass = 10 };

ScriptState state = null;

CSharpScript.RunAsync(@"
    bool shouldOpenClass = NumberOfStudents &gt;= StudentsPerClass;
    int numberOfClasses = NumberOfStudents/StudentsPerClass;
", globals: globals)
.ContinueWith(s =&gt; state = s.Result).Wait();

Assert.AreEqual(true, state.GetVariable("shouldOpenClass").Value);
Assert.AreEqual(8, state.GetVariable("numberOfClasses").Value);
</code></pre>

<p>Those are just a few examples and I recommend you check out the <a href="https://github.com/dotnet/roslyn">Roslyn Github Repository</a>.</p>


    

	<div class="post-social-links">
        <a href="https://twitter.com/gsferreira"><img src="/images/000-twitter-bird-48.png" title="gsferreira"/></a>
        <a href="https://gsferreira.com/rss.xml"><img src="/images/000-rss-feeds-48.png" title="gsferreira.com feed" onClick="_gaq.push(['_trackEvent', 'Post', 'RssSubscribe', 'Rss Subscribe on Post']);"/></a>
    </div>

  <br />
  
  <script async data-uid="6b1314a04e" src="https://gsferreira.ck.page/6b1314a04e/index.js"></script>


	<div class="addthis_toolbox addthis_default_style" style="float:right;">
        <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
        <a class="addthis_button_tweet"></a>
        <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
        <a class="addthis_button_linkedin_counter"></a>
        <a class="addthis_counter addthis_pill_style"></a>
    </div>
	
    <div id="disqus_thread"></div>
<script>
    var reset_disqus = function(){
        DISQUS.reset({
            reload: true,
            config: function () {
                //this.page.identifier = '';
                this.page.url = 'http://gsferreira.com/archive/2016/02/the-shining-new-csharp-scripting-api/';
                //this.page.title = '';
            }
        });
    };

    var disqus_shortname = 'gsferreira';
    var disqus_url = 'http://gsferreira.com/archive/2016/02/the-shining-new-csharp-scripting-api/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    window.addEventListener('orientationchange', reset_disqus);
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-****"></script>



                </div>
                <!-- #content -->
            </div>
            <!-- #primary .site-content -->
        </div>
        <!-- #main -->

        <footer class="site-footer" role="contentinfo">
            <div class="site-info">
                Powered by <a href="https://github.com/Sandra/Sandra.Snow" rel="generator">Sandra.Snow</a> using <a href="https://github.com/gsferreira/letsnow" rel="generator">letsnow theme</a>.	
            </div>
            <!-- .site-info -->
        </footer>
        <!-- #colophon .site-footer -->
    </div>
    <!-- #page .hfeed .site -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script src='/javascripts/prettify.js' type='text/javascript'></script>
    
    <script type="text/javascript">
var _gaq = _gaq || [];

_gaq.push(['_setAccount', 'UA-33436813-1']);
_gaq.push(['_trackPageview']);
        
(function () {
    var ga = document.createElement('script');
    ga.type = 'text/javascript';
    ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(ga, s);
})();
</script>
    
    <script type='text/javascript'>
      $(function () {
        $("pre code").parent().each(function () {
          if (!$(this).hasClass("prettyprint")) {
            $(this).addClass("prettyprint");
            a = true
          }
        });

        prettyPrint();
      });
    </script>
</body>
</html>
